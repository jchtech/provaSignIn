<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Google One Tap Authentication Sample</title>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
   
</head>

<body>

    <div id="no-auth" class="container">
        <h1 id="welcome">Hello there!</h1>
        <div id="alternative-login">
          <p><b>If no prompt appears just click the button bellow to start the authentication flow:</b></p>
          <div id="buttonDiv"></div>
        </div>

        <div id="authenticated" style="display:none">
          <h3>Looks like you have already authenticated yourself!</h3>
          <p><b>Here is the info I recovered about your profile in your Google account:</b></p>
          <table id="token-table">
            <thead>
              <tr>
                <th>Key</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
    </div>
 
<script>
  window.isAuthenticated = false;
  window.identity = {};
  window.token = '';

  function handleCredentialResponse(response) {
    window.token = response.credential;
    window.identity = parseJwt(response.credential);
    window.isAuthenticated = true;
    showAuthInfo();
  }

  function populateTable() {
    var table = document.getElementById("token-table");
    var keys = Object.keys(window.identity);
    var j = 0;
    for (var i = 1; i < keys.length; i++) {
        var row = table.insertRow(i);
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        cell1.innerHTML = keys[j];
        cell2.innerHTML = window.identity[keys[j]];
        j++;
    }
  }

function destroyTable() {
    var table = document.getElementById("token-table");
    var rowCount = table.rows.length;
    for (var i = 1; i < rowCount; i++) {
        table.deleteRow(i);
    }
}

function showAuthInfo() {
    if (window.isAuthenticated) { 
        document.getElementById("authenticated").style.removeProperty('display');
        document.getElementById("welcome").innerHTML = `Hello <b>${window.identity.name}!</b><img src="${window.identity.picture}" alt="Avatar" style="padding: 0 2rem 0 2rem; border-radius: 50%;">`;
        document.getElementById("alternative-login").style.setProperty('display', 'none');
        document.getElementById("raw-token").innerText = window.token;
        populateTable();
    } else {
        document.getElementById("authenticated").style.setProperty('display', 'none');
        document.getElementById("welcome").innerText = 'Hello there!';
        document.getElementById("alternative-login").style.removeProperty('display');
        destroyTable();
    }
}

window.onload = function () {
    window.isAuthenticated = false;
    showAuthInfo();
    google.accounts.id.initialize({
        client_id: "1009336245126-7a1g0qdglr9l7svpusr60h77bps9h6pr.apps.googleusercontent.com",
        callback: handleCredentialResponse,
        auto_select: true,
    });
    google.accounts.id.renderButton(
        document.getElementById("buttonDiv"),
        { theme: "outline", size: "large" }  // customization attributes
    );
    google.accounts.id.prompt(); // also display the One Tap dialog
}


// Source: https://stackoverflow.com/a/47574303/4064162 Answer by user "Rafael Quintela"
// token, You can try to decode it by yourself in a webpage like "https://jwt.io/" or "https://jwt.ms/"
let b64DecodeUnicode = str =>
  decodeURIComponent(
    Array.prototype.map.call(atob(str), c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''))

let parseJwt = token =>
  JSON.parse(
    b64DecodeUnicode(
      token.split('.')[1].replace('-', '+').replace('_', '/')
    )
  )

</script>
</body>
</html>